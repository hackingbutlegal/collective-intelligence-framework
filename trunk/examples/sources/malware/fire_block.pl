#!/usr/bin/perl -w

use strict;
use Error qw(:try);
use Data::Dumper;
use DateTime;
use DateTime::Format::DateParse;
use CIF::Message::Infrastructure;
use CIF::Message::Inet;
use CIF::Message::InetWhitelist;
use LWP::Simple;

my $url = 'http://maliciousnetworks.org/fire-blocklist.txt';
my $dt = DateTime->from_epoch(epoch => time());
$dt = $dt->ymd().'T00:00:00Z';

my $content = get($url) || die('failed to get url: '.$!);
my @lines = split(/\n/,$content);

foreach (@lines){
    next if(/^#/);
    next if(/^$/);
    next if(/^\r/);
    my ($addr,$asn) = split(/\s+/,$_);

    my ($as,$network,$ccode,$rir,$date,$as_desc) = CIF::Message::Inet::asninfo($addr);

    warn CIF::Message::Infrastructure->insert({
        address     => $addr,
        source      => 'maliciousnetworks.org',
        description => 'maliciousnetworks.org - '.$addr,
        impact      => 'suspicious address',
        confidence  => 3,
        severity    => 'medium',
        asn         => $as,
        cidr        => $network,
        asn_desc    => $as_desc,
        cc          => $ccode,
        rir         => $rir,
        restriction => 'need-to-know',
        alternativeid  => 'http://maliciousnetworks.org/ipinfo.php?as='.$as,
        alternativeid_restriction => 'public',
        detecttime  => $dt,
    });
}
