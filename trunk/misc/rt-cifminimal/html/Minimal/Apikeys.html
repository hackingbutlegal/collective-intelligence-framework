<& Elements/Header, Title => loc('Apikeys') &>
<& /Elements/ListActions, actions => \@results &>
<& Elements/ApikeyGeneration, 
    %ARGS 
&>
<& Elements/ApikeyDisplay, 
    recs    => \@recs,
    %ARGS 
&>
<& Elements/ApikeyDisplayGroups,
    groups  => \%group_map,
    %ARGS
&>

<%INIT>
use Data::Dumper;
require CIF::WebAPI::APIKey;
my $user = $session{'CurrentUser'}->UserObj();

my $g = $user->OwnGroups();
my %group_map;
while(my $grp = $g->Next()){
    my $guid = $grp->FirstCustomFieldValue('CIF Guid');
    my $gpriority = $grp->FirstCustomFieldValue('CIFGroupPriority');
    next unless($guid);
    $group_map{$gpriority} = $guid;
}
my @sorted = sort { $a <=> $b } keys(%group_map);

if($GenerateKey){
    my $id = CIF::WebAPI::APIKey->genkey(
        uuid_alias      => $user->EmailAddress(),
        description     => $key_description,
        groups          => join(',',map { $group_map{$_} } @sorted),
        default_guid    => $group_map{$sorted[0]},
    );
    push(@results,'key '.$id->uuid().' successfully generated');
}

if($PurgeKey){
    my $r = CIF::WebAPI::APIKey->retrieve(uuid => $uuid);
    my $_uuid = $r->uuid();
    if($r->delete()){
        push(@results,$_uuid.' deleted');
    } else {
        push(@results,'error trying to delete: '.$_uuid);
    }
}

my @recs = CIF::WebAPI::APIKey->search(uuid_alias => $user->EmailAddress());

#A hack to make sure that session gets rewritten.
$session{'i'}++;
</%INIT>

<%ARGS>
$GenerateKey => undef
$PurgeKey => undef
$uuid => undef
$key_description => undef
@results => undef
</%ARGS>
