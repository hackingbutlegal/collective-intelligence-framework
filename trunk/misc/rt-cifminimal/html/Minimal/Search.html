<& /Minimal/Elements/Header, 
    Title       => $title,
    current_tab => "/Minimal/Search.html",
&>
<& /Elements/ListActions, actions => \@results &>

% $m->comp('Elements/SearchBox');
% if($text){
<pre>
<% $text %>
</pre>
% }

<%INIT>
my $title = loc("Collective Intelligence");
my $cif_config = RT->Config->Get('CIFMinimal_CIFConfig') || $ENV{'HOME'}.'/.cif';
$text = undef;

if($q){
    if($q =~ /^#?(\d+)$/){
        RT::Interface::Web::Redirect(RT->Config->Get('WebURL')."Minimal/Display.html?id=".$1);
    } else {
        require CIF::Client;

        my ($client,$err) = CIF::Client->new({
            config          => $cif_config,
            simple_hashes   => 1,
            fields          => 'restriction,source,severity,confidence,address,portlist,protocol,impact,description,detecttime',
        });
        require CIF::WebAPI::APIKey;
        my @recs = CIF::WebAPI::APIKey->search(uuid_alias => $session{'CurrentUser'}->UserObj->EmailAddress());
        unless($recs[0] && $recs[0]->uuid()){
            # generate apikey
            require RT::CIFMinimal;
            my $id = RT::CIFMinimal::generate_apikey({ user => $session{'CurrentUser'}->UserObj(), key_description => 'generated automatically for WebUI search' });
            push(@recs,$id);
            push(@results,'default WebUI apikey '.$id->uuid().' automatically generated');
        }
        $client->{'apikey'} = $recs[0]->uuid();
        my @res;
        my @qarray = split(/,/,$q);
        foreach(@qarray){
            my $feed = $client->GET(
                query   => $_,
                limit   => 25,
            );
            require CIF::Client::Plugin::Table;
            my $t = CIF::Client::Plugin::Table->write_out($client,$feed);
            push(@res,$t);
        }
        $text = join("\n",@res) if($#res > -1);
    }

}
</%INIT>


<%ARGS>
$q => undef
$text => undef
@results => undef
</%ARGS>

