<& Elements/Header, Title => loc("Submission Results") &>
<& /Elements/ListActions, actions => \@results &>
<%INIT>

unless($data){
    RT::Interface::Web::Redirect(RT->Config->Get('WebURL').'Minimal/Front.html');
}

use Regexp::Common qw/net/;
require XML::IODEF::Simple;
require CIF::Utils;

# just in case someone tries to set it on their own
# w/o the proper rights
unless($session{'CurrentUser'}->Privileged()){
    $confidence = RT->Config->Get('CIFMinimal_DefaultConfidence') || 85;
}

my $guid = (CIF::Utils::isUUID($group)) ? $group : CIF::Utils::genSourceUUID($group);

my $constituency_cf = RT::IR->CustomFields( 'Constituency', Queue => $Queue );
my $constituency_field = 'Object-RT::Ticket--CustomField-' . $constituency_cf->id .'-Values';
$ARGS{$constituency_field} = $group;

my @datas = split(/,/,$data);
foreach $data (@datas){
    $data = lc($data);

    my $report = XML::IODEF::Simple->new({
        guid            => $guid,
        restriction     => $restriction,
        description     => $description,
        impact          => $assessment,
        address         => $data,
        protocol        => $protocol,
        portlist        => $portlist,
        contact         => {
            name            => $session{'CurrentUser'}->RealName(),
            email           => $session{'CurrentUser'}->EmailAddress(),
        },
        purpose         => $purpose,
        confidence      => $confidence,
        alternativeid               => $alternativeid,
        alternativeid_restriction   => 'public',
    });

    my $subject = $description;
    $subject = $assessment.' '.$description if($assessment);

    my $msg = $report->out();

    
    $ARGS{'Subject'} = $subject;
    $ARGS{'Queue'} = 'Incident Reports';
    my ($ticket,@res) = CreateTicket(Content => $msg, Attachments => $session{'Attachments'}, %ARGS, Status => 'new');
    $ticket->Comment(Content => $ARGS{'ReferenceDescription'});
    if($ticket->Status() eq 'rejected'){
        push(@results,'Ticket contained bad-data (private address?), auto-rejected');
    } else {
        push(@results,@res);
    }
    push(@results,$msg) if(RT->Config->Get('LogToSyslog') eq 'debug');
}

</%INIT>

<%ARGS>
$group => undef
$purpose => RT->Config->Get('CIFMinimal_DefaultPurpose') || 'mitigation'
$data => undef
$restriction => undef
$description => undef
$protocol => undef
$portlist => undef
@results => undef
$assessment => undef
$Queue => 'Incident Reports'
$confidence => RT->Config->Get('CIFMinimal_DefaultConfidence') || 85;
$alternativeid => undef
</%ARGS>
