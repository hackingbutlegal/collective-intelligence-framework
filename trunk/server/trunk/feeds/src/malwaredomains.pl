#!/usr/bin/perl -w

use strict;
use warnings;

use Data::Dumper;
use DateTime;
use DateTime::Format::DateParse;
use Net::DNS;
use LWP::Simple;
use Encode qw/encode_utf8/;

use CIF::Message::Malware;
use CIF::Message::DomainSimple;
use Getopt::Std;

my %opts;
getopts('d',\%opts);
my $debug = $opts{'d'};

my $partner = 'malwaredomains.com';
my $url = 'http://www.malwaredomains.com/files/domains.txt';
my $timeout = 5;
my $content = encode_utf8(get($url));
my @lines = split(/\n/,$content);
foreach (@lines){
    $_ =~ s/\r//;
    $_ =~ s/^[\t]+//;
    $_ =~ s/[\t]+/,/g;
}

foreach (@lines){
    next if(/^#/);
    warn $_ if($debug);
    my ($domain,$type,$orig_ref,$date) = split(/,/);
    warn $domain if($debug);

    $type = 'unknown' if($type eq 'malware' || $type eq 'threat');

    $date = eval { DateTime::Format::DateParse->parse_datetime($date) };
   
    my $uuid; 
    if($orig_ref =~ /md5\=([0-9a-fA-F]{32})$/){
        my $hash_md5 = $1;
        $uuid = CIF::Message::Malware->insert({
            description => 'malware '.$type.' - '.$hash_md5,
            source      => $partner,
            hash_md5    => $hash_md5,
            impact      => 'malware '.$type,
            restriction => 'need-to-know',
            severity    => 'medium',
            confidence  => 5,
            alternativeid  => 'http://www.malwaredomains.com/files/domains.txt',
            alternativeid_restriction => 'public',
            detecttime  => $date,
       });
       $uuid = $uuid->uuid();
    }
    
    my $impact = 'malicious domain '.$type;
    my $desc = $impact.' '.$domain;

    my $id = CIF::Message::DomainSimple->insert({
        nsres       => Net::DNS::Resolver->new(['8.8.8.8','8.8.8.4']),
        relatedid   => $uuid,
        address     => $domain,
        source      => $partner,
        confidence  => 5,
        severity    => 'medium',
        impact      => $impact,
        description => $desc,
        detecttime  => $date,
        restriction => 'need-to-know',
        alternativeid  => 'http://www.malwaredomains.com/files/domains.txt',
        alternativeid_restriction => 'public',
    });
    print $domain.' -- '.$id."\n";
}
