package CIF::Archive::DataType::Plugin::Malware;
use base 'CIF::Archive::DataType';

use strict;
use warnings;

use Module::Pluggable require => 1, search_path => ['CIF::Archive::DataType::Plugin::Malware'];

__PACKAGE__->table('malware');
__PACKAGE__->columns(Primary => 'id');
__PACKAGE__->columns(All => qw/id uuid description source hash_sha1 hash_md5 content impact confidence severity restriction alternativeid alternativeid_restriction detecttime created/);
__PACKAGE__->columns(Essential => qw/id uuid description hash_sha1 hash_md5 restriction created/);
__PACKAGE__->sequence('malware_id_seq');

sub prepare {
    my $class = shift;
    my $info = shift;
    
    return(undef) unless($info->{'impact'} && $info->{'impact'} eq 'malware');

    my $hash = $info->{'hash_sha1'} || $info->{'hash_md5'} || return(undef);
    $hash = lc($hash);

    return(undef) unless($hash =~ /^[a-f0-9]{32,40}$/);
    return(1);
}

sub insert {
    my $self = shift;
    my $info = shift;
   
    my $tbl = $self->table();
    foreach($self->plugins()){
        if(my $t = $_->prepare($info)){
            $self->table($t);
        }
    }
 
    my $id = eval { $self->SUPER::insert({
        uuid        => $info->{'uuid'},
        description => lc($info->{'description'}),
        source      => $info->{'source'},
        hash_md5    => $info->{'hash_md5'},
        hash_sha1   => $info->{'hash_sha1'},
        content     => $info->{'content'},
        impact      => $info->{'impact'},
        confidence  => $info->{'confidence'},
        severity    => $info->{'severity'},
        restriction => $info->{'restriction'} || 'private',
        detecttime  => $info->{'detecttime'},
        alternativeid   => $info->{'alternativeid'},
        alternativeid_restriction => $info->{'alternativeid_restriction'} || 'private',
    }) };
    if($@){
        die $@ unless($@ =~ /duplicate key value violates unique constraint/);
        $id = $self->retrieve(uuid => $info->{'uuid'});
    }
    $self->table($tbl);
    return($id);
}

sub lookup {
    my $self = shift;
    my $info = shift;
    
    my $query = $info->{'query'};
    return(undef) unless($query =~ /^[a-f0-9]{32,40}$/);

    my $sth = $self->sql_hash_md5();
    if($query =~ /^[a-f0-9]{40}$/){
        $sth = $self->sql_hash_sha1();
    }
    my $r = $sth->execute($query,$info->{'limit'});
    my $ret = $sth->fetchall_hash();
    return($ret);
}

sub feed {
    my $class = shift;
    my $info = shift;

    $info->{'key'} = 'hash_md5';
    return($class->SUPER::feed($info));
}

__PACKAGE__->set_sql('hash_md5' => qq{
    SELECT * FROM __TABLE__
    WHERE lower(hash_md5) = lower(?)
    ORDER BY detecttime DESC, created DESC, id DESC
    LIMIT ?
});

__PACKAGE__->set_sql('hash_sha1' => qq{
    SELECT * FROM __TABLE__
    WHERE lower(hash_sha1) = (?)
    ORDER BY detecttime DESC, created DESC, id DESC
    LIMIT ?
});
1;
__END__
