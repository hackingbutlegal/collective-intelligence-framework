<%ARGS>
$reporttime => undef
$format => 'text' 
</%ARGS>
<%INIT>
use RT::Interface::REST;
use CIF::Message::Infrastructure;
use RT::CIF;

my $status = '200 Ok';
my $output;

$format = $m->dhandler_arg() if($m->dhandler_arg());

if($format !~ /^\S+$/){
    $status = '409 Syntax Error';
    $output = 'invalid format given: '.$format;
    goto OUTPUT;
}

my $hash;
my @recs;

if($reporttime){
    CIF::Message::Infrastructure->set_sql('custom', qq{
        SELECT * FROM infrastructure
        WHERE reporttime >= ?
        AND (impact LIKE '%malware%')
        ORDER BY reporttime DESC
    });
    @recs = CIF::Message::Infrastructure->search_custom($reporttime);
} else {
    @recs = CIF::Message::Infrastructure->search_like(impact => '%malware%');
}

foreach my $rec (@recs){
    next if(RT::CIF::isPrivateAddress($rec->address()));
    next if(exists($hash->{$rec->address()}));
    $hash->{$rec->address()} = $rec;
    $hash->{$rec->address()}->{'asn'} = $rec->asn() || 0;
}

$output = eval { $m->comp('/REST/1.0/cif/output/inet/'.$format, recs => $hash) };
if($@){
    $output = $m->comp('/REST/1.0/cif/output/inet/text', recs => $hash);
}

OUTPUT:
$m->out("RT/". $RT::VERSION . " " . $status ."\n\n");
$m->out($output);
</%INIT>
