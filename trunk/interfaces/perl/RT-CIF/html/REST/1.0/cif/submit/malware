<%ARGS>
$POSTDATA => undef
</%ARGS>
<%INIT>
use RT::Interface::REST;
use CIF::Message::Malware;
use JSON;
my %tests;
$tests{'restriction'} = qr/^(private|default|need-to-know|public)$/;
$tests{'severity'} = qr/^(high|medium|low)$/;
$tests{'confidence'} = qr/^[0-9]$/;
$tests{'hash_md5'} = qr/^[0-9a-fA-F]{32}$/;
$tests{'hash_md5'} = qr/(^[0-9a-fA-F]{40}$|^$)/;
$tests{'description'} = qr/^\S+/;

my $content = $POSTDATA;
my @a = @{decode_json($content)};

my @ids;
foreach (@a){
    my $rec = $_;
    foreach my $test (keys %tests){
        unless($rec->{$test} =~ /$tests{$test}/){
            $m->out('input validation failure: '.$test.'/'.$rec->{$test});
            $m->abort();
        }
    }
    my $description = $_->{'description'};
    my $severity = (lc($_->{'severity'}) eq 'low') ? 'low' : 'medium';
    my $impact = 'malware';
    my $description = $_->{'description'}.' '.$_->{'hash_md5'};

    my $id = CIF::Message::Malware->insert({
        source      => $session{'CurrentUser'}->EmailAddress(),
        severity    => $severity,
        confidence  => $_->{'confidence'},
        detecttime  => $_->{'detecttime'},
        restriction => $_->{'restriction'} || 'private',
        description => $_->{'description'},
        hash_md5    => $_->{'hash_md5'},
        hash_sha1   => $_->{'hash_sha1'},
        impact      => $impact;
        alternativeid   => $_->{'alternativeid'},
        alternativeid_restriction => $_->{'alternativeid_restriction'},
    });
    push(@ids,$id) if($id);
}
$m->out('['.join(',', map { '{"uuid":'.'"'.$_->uuid().'"}' } @ids).']');

</%INIT>
